var col=require("./collections.js"),fnc={startsWith:require("./startswith.js").startsWith,createScope:require("./scope.js").createScope};exports.processLine=function(e,t,i){i.beginLine();var n,a,s=e.trim(),l=fnc.createScope(),r=fnc.startsWith('"',s,2);if(r.startsWith)t.hasElementScope("blockquote")&&0===r.remainingLine.trim().length||(t.isImplicitParagraphScope()&&i.endCurrentScopeWithoutLineBreak(t),t.pushBlock({element:"blockquote",spec:'""'}),r.element="blockquote",i.applyOptions(r),i.openTag("blockquote",r.id,r.classes,r.dataPairs),s=r.remainingLine,a=!0);else{var o=fnc.startsWith("'",s,2);if(o.startsWith)t.hasElementScope("p")&&0===o.remainingLine.trim().length||(t.isImplicitParagraphScope()&&i.endCurrentScopeWithoutLineBreak(t),t.pushBlock({element:"p",spec:"''"}),o.element="p",i.applyOptions(o),i.openTag("p",o.id,o.classes,o.dataPairs),s=o.remainingLine,a=!0);else{var p=fnc.startsWith("-",s,3);if(p.startsWith&&0===p.remainingLine.trim().length)t.isImplicitParagraphScope()&&i.endCurrentScopeWithoutLineBreak(t),p.element="hr",i.applyOptions(p),i.selfClosingTag("hr",p.id,p.classes,p.dataPairs),s=p.remainingLine,a=!0;else{var c=fnc.startsWith("%&",s,2);if(c.startsWith)t.hasElementScope("ul")&&0===c.remainingLine.trim().length||(t.isImplicitParagraphScope()&&i.endCurrentScopeWithoutLineBreak(t),t.pushBlock({element:"ul",spec:"%&"}),c.element="ul",i.applyOptions(c),i.openTag("ul",c.id,c.classes,c.dataPairs),s=c.remainingLine,a=!0);else{var h=fnc.startsWith("%+",s,2,!1,!0);if(h.startsWith)t.hasElementScope("ol")&&0===h.remainingLine.trim().length||(t.isImplicitParagraphScope()&&i.endCurrentScopeWithoutLineBreak(t),t.pushBlock({element:"ol",spec:"%+"}),h.element="ol",h.numberCapture?(i.applyOptions(h),i.openTag("ol",h.id,h.classes,h.dataPairs,"start='"+h.numberCapture+"'")):(i.applyOptions(h),i.openTag("ol",h.id,h.classes,h.dataPairs)),s=h.remainingLine,a=!0);else{var m=fnc.startsWith("$",s,4);m.startsWith&&(t.inDataBlock()&&0===m.remainingLine.trim().length||(t.startDataBlock(m),i.options.generateIds||(i.options.implicitGenerateIds=!0,i.options.generateIds=!0),s=m.remainingLine,a=!0))}}}}}var u=fnc.startsWith("#",s);if(u.startsWith)l.pushBlock({element:"h"+u.symbolCount}),u.element="h",i.applyOptions(u),i.openTag("h"+u.symbolCount,u.id,u.classes,u.dataPairs),s=u.remainingLine,n=!0;else{var g=fnc.startsWith("+",s);g.startsWith&&0!==g.remainingLine.trim().length?(t.hasElementScope("ol")||(t.pushBlock({element:"ol",spec:"++",implicit:!0}),i.openTag("ol")),l.pushBlock({element:"li"}),g.element="li",i.applyOptions(g),i.openTag("li",g.id,g.classes,g.dataPairs),s=g.remainingLine,n=!0):(g=fnc.startsWith("&",s),g.startsWith&&0!==g.remainingLine.trim().length&&(t.hasElementScope("ul")||(t.pushBlock({element:"ul",spec:"&&",implicit:!0}),i.openTag("ul")),l.pushBlock({element:"li"}),g.element="li",i.applyOptions(g),i.openTag("li",g.id,g.classes,g.dataPairs),s=g.remainingLine,n=!0))}if(!n&&!a&&0===s.length)for(;t.hasCurrentBlock()&&"blockquote"!=t.currentBlockElement();)i.endCurrentScope(t);var d,k=!1;if(s.length>1){var f,B=s.substring(s.length-2,s.length);if("''"==B&&t.hasElementScope("p"))d="p",f=2;else if('""'==B&&t.hasElementScope("blockquote"))d="blockquote",f=2;else if("%&"==B&&t.hasElementScope("ul"))d="ul",f=2;else if("%+"==B&&t.hasElementScope("ol"))d="ol",f=2;else if(s.length>3){var S=s.substring(s.length-4,s.length);"$$$$"==S&&t.inDataBlock()&&(i.options.implicitGenerateIds&&(i.options.generateIds=!1),t.finishDataBlock(),s=s.substring(0,s.length-4).trim())}d&&(s=s.substring(0,s.length-f).trim())}if(l.hasCurrentBlock()||t.hasCurrentBlock()&&"blockquote"!=t.currentBlockElement()||!(s.length>0)||(t.pushBlock({element:"p",spec:"''",implicit:!0}),i.openTag("p")),d){for(k=!0,i.addInline(s),i.endScopeWithoutLineBreak(l);t.hasCurrentBlock()&&t.currentBlockElement()!=d;)i.endCurrentScopeWithoutLineBreak(t);i.endCurrentScopeWithoutLineBreak(t)}k||(i.addInline(s),i.endScope(l))};