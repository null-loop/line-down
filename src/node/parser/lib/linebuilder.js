var col=require("./collections.js"),inl=require("./inline.js");exports.createBuilder=function(e,n){return{_outputLines:[],_generateIdsFor:["h","li","p","blockquote"],currentLine:"",options:e,scope:n,generateId:function(e){var n=!1;if(("h"==e.element||"p"==e.element||"li"==e.element)&&(n=!0),n){var t=e.remainingLine,i=100;t.length>i&&(t=t.substring(0,i));for(var o=this.formatDataKey(t),r=o,s=0;this.scope.hasUsedId(o);)s++,o=r+"-"+s.toString();return o}return void 0},applyOptions:function(n){e&&e.generateIds&&!n.id&&(n.id=this.generateId(n))},beginLine:function(){""!==this.currentLine&&this._outputLines.push(this.currentLine),this.currentLine=""},complete:function(){""!==this.currentLine&&this._outputLines.push(this.currentLine)},formatDataKey:function(e){function n(e){return 1===e.length&&e.match(/[a-z]/i)}var t="",i=e.split(""),o=!1;for(col.each(i,function(e,i){if(n(i)){var r=i.toLocaleUpperCase();r==i?o&&(i="-"+i,o=!1):o=!0}else i="-";t+=i.toLocaleLowerCase()});t.indexOf("--")>-1;)t=t.replace("--","-");return t},tagWithEnd:function(e,n,t,i,o,r){var s="<"+e;if(n&&(this.scope.hasUsedId(n)||(s=s+" id='"+n+"'",this.scope.usedId(n))),t&&(t=t.split("&"),t=t.join(" "),s=s+" class='"+t+"'"),i){var a=this;col.each(i,function(e,n){s=s+" data-"+a.formatDataKey(n.key)+"='"+n.value+"'"})}o&&(s=s+" "+o),s+=r,this.append(s)},openTag:function(e,n,t,i,o){this.tagWithEnd(e,n,t,i,o,">")},selfClosingTag:function(e,n,t,i){this.tagWithEnd(e,n,t,i,void 0,"/>")},append:function(e){this.currentLine=this.currentLine+e},closeTag:function(e){this.append("</"+e+">")},result:function(){var e="";return col.each(this._outputLines,function(n,t){n>0&&(e+="\r\n"),e+=t}),e},endScope:function(e){for(;e.hasCurrentBlock();){var n=e.popBlock();this.closeTag(n.element),this.beginLine()}},endScopeWithoutLineBreak:function(e){for(;e.hasCurrentBlock();){var n=e.popBlock();this.closeTag(n.element)}},endCurrentScope:function(e){if(e.hasCurrentBlock()){var n=e.popBlock();this.closeTag(n.element),this.beginLine()}},endCurrentScopeWithoutLineBreak:function(e){if(e.hasCurrentBlock()){var n=e.popBlock();this.closeTag(n.element)}},addInline:function(e){inl.replaceInline(e,this)},writeDataBlocks:function(e){var n=this;e&&e.length>0&&(console.log("Writing data blocks"),col.each(e,function(e,t){var i=t.id,o=t.classes?t.classes.toLocaleLowerCase():"json",r="json"==o?"application/json":"jsonp"==o?"application/javascript":"xml"==o?"application/xml":"text/plain";n.beginLine(),n.openTag("script",i,void 0,void 0,"type='"+r+"'"),n.beginLine(),n.closeTag("script")}))}}};